# 割り勘・請求管理アプリ「Walico（ワリコ）」要件定義書

## 1. プロジェクト概要

- **アプリ名:** Walico（ワリコ）
- **目的:** 恋人・友人とのデートや食事における「立て替え払いの請求忘れ」を防ぎ、精算ストレスをゼロにする。
- **コンセプト:** **「3 秒で完結」**。ログイン不要、財布をしまう流れで入力から LINE 送信までを完了させる。
- **コアバリュー:**
- **No Login:** ユーザー登録一切不要。誰でも即座に使える。
- **Speed:** アプリ起動から請求まで最短フローで設計。
- **Privacy:** 画像は一時保管のみ。個人情報は保持しない。
- **Reliance on LINE:** 履歴管理や相手への通知は日常使う LINE に委ねる。

## 2. 技術スタック

- **Frontend:** Next.js (App Router) / TypeScript
- **PWA Framework:** `next-pwa`
- **Styling:** Tailwind CSS
- **Database:** **Turso (sqlite)**
- _役割: 共有用 URL の発行と、一時的な請求データの保持。_

- **Object Storage:** **Cloudflare R2**
- _役割: レシート画像の一時保存（短期間でライフサイクル削除）。_

- **AI (OCR/Vision):** **Gemini 2.0 Flash**
- _役割: レシートの品目・金額・合計の即時解析。_

- **Infrastructure:** Vercel (Frontend/API)

## 3. 機能要件

### 3.1 認証・ユーザー管理

- **ログイン機能:** **なし**。
- アプリは「ステートレス（状態を持たない）」なツールとして振る舞う。

### 3.2 レシート解析フロー (AI モード)

1. **撮影 & アップロード:**

- ホーム画面の「巨大ボタン」からカメラ起動/画像選択。
- Cloudflare R2 へ即時アップロード。

2. **AI 解析 (Gemini 2.0 Flash):**

- 抽出データ: 店名、日時、合計金額、明細リスト（品名・価格）。

```json: 抽出例
{
  "store_name": "サンディ",
  "date": "2025-12-22",
  "items": [
    {
      "name": "白才1/4",
      "price": 89
    },
    {
      "name": "豚",
      "price": 380
    },
    {
      "name": "豆泉庵うすあげ",
      "price": 39
    },
    {
      "name": "昔ながらのミニ木綿",
      "price": 87
    },
    {
      "name": "サンミルク",
      "price": 199
    }
  ],
  "total_amount": 857
}
```

1. **編集機能:**

- AI が誤認識した場合に備え、解析後の「品名」「価格」はタップして手動修正可能にする。

### 3.3 手入力フロー (マニュアルモード)

- **入力項目:** 「店名（任意）」「合計金額」のみ。
- **制限事項:** **明細（詳細展開）機能は使用不可**とする。
- 理由: 手入力で詳細を入れるのはコンセプト（Speed）に反するため。手入力時は「簡易割り勘（スライダー）」のみ提供する。

### 3.4 計算ロジック（ハイブリッド UI）

- **レベル 1：簡易モード（デフォルト）**
- **スライダー操作:** 「自分 : 相手」の比率調整（初期値 50:50）。
- **端数処理:** ワンタップで「100 円単位切り上げ/切り捨て」など。
- **リアルタイム表示:** 相手への請求額を即座に更新。

- **レベル 2：明細モード（AI モード時のみ・オプション）**
- **アコーディオン展開:** デフォルトは非表示。ユーザーが操作した時のみ展開。
- **個別仕分け:** 各品目を「自分」「相手」「割り勘」に振り分け可能。

### 3.5 共有・データ確定 (LINE 連携)

1. **確定アクション:**

- 画面下部の「LINE で請求する」ボタン押下。

2. **データ保存:**

- Turso へトランザクションデータを保存し、ユニークな URL（例: `walico.app/receipt/uuid`）を発行。

3. **LINE 起動 (URL Scheme):**

- 以下の形式のテキストをセットして LINE を起動。
- `「[店名]の代金 ¥[請求額] お願い！ レシート詳細: https://walico.app/r/[uuid]」`

4. **共有先ページ (Recipient View):**

- URL を開くと、相手側には「読み取り専用」のレシート詳細・金額内訳が表示される。

## 4. データモデル設計案 (Turso)

ユーザーテーブル不要のシンプルな構成です。

### Transactions Table

| Column              | Type    | Note                             |
| ------------------- | ------- | -------------------------------- |
| `id`                | TEXT    | UUID (PK) - URL の一部になる     |
| `store_name`        | TEXT    | 店名                             |
| `total_amount`      | INTEGER | 合計金額                         |
| `request_amount`    | INTEGER | **相手への請求額**               |
| `receipt_image_url` | TEXT    | R2 のパス (一定期間後無効)       |
| `items_json`        | JSON    | 明細データ (AI モード時のみ保存) |
| `created_at`        | INTEGER | 作成日時                         |
| `expires_at`        | INTEGER | 有効期限 (例: 7 日後など)        |

## 5. 画面構成 (UI/UX)

**モバイル PWA レイアウト (片手操作特化)**

### 5.1 ホーム画面 (待機状態)

- **Header:** Walico ロゴ
- **History Area:** LocalStorage 内の直近利用履歴（タップで共有 URL を再表示）。
- **Action Area (Bottom Fixed):**
- **Primary:** 📸 **レシート撮影**（画面幅いっぱいの巨大ボタン）
- **Secondary:** ⌨️ **手入力**（ボタンの下にテキストリンク配置）

### 5.2 入力・編集画面

- **AI モード時:** 解析結果（店名・合計）を表示。下部に「明細リスト（アコーディオン）」配置。
- **手入力モード時:** 電卓ライクな数値入力画面。明細機能は非表示。
- **Common:** 画面中央に「割り勘スライダー」。

### 5.3 確定・送信ボタン

- 画面最下部に固定。「LINE で送る（¥ 〇〇〇〇）」と金額込みで表示。

## 6. 請求詳細画面 (Receiver View / Public)

**目的:** URL を受け取った相手が、支払額を確認し、完了報告をする。

### 6.1 UI 構成

1.  **Status Header:**
    - 未払い時: 「支払いをお願いします 🙏」
    - 支払い済時: 「支払い完了 🎉」
2.  **Payment Amount (Hero):**
    - 相手が支払うべき金額を特大サイズで表示。
    - 配色はテーマカラー (Emerald-500) を使用。
3.  **Transaction Details (Card):**
    - 店舗名、利用日
    - **計算式:** 合計金額 × 負担率 ＝ 請求額
    - **Itemized List (条件付き):** AI 解析データがある場合、「あなたが払うもの」リストを展開表示。
4.  **Receipt Proof:**
    - 「レシート画像を確認」ボタン（アコーディオンまたはモーダル）。
5.  **Action Button (Sticky Bottom):**
    - Label: 「支払いを完了しました」
    - Interaction: タップ後、DB の状態を更新し、ボタンを無効化（Disabled）または「支払い済み」表示に切り替え。

### 6.2 ステータス管理

- このページはログイン不要でアクセス可能。
- `transactions` テーブルに `status` (pending/paid) カラムを追加し、このボタンでトグルさせる。
